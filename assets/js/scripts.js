"use strict";function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function _defineProperties(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}function _createClass(a,b,c){return b&&_defineProperties(a.prototype,b),c&&_defineProperties(a,c),Object.defineProperty(a,"prototype",{writable:!1}),a}$(document).on("rex:ready",function(){new QuickEdit});var QuickEdit=function(){function a(){var b=this;_classCallCheck(this,a),this.ADD_CLASS=1,this.REMOVE_CLASS=2,this.active=null,this.activeFrame=null,this.activeRowSelector=null,this.frameId=null,this.$rexAjaxLoader=$("#rex-js-ajax-loader"),this.attachEventHandler(),$(document).on("keyup",function(a){"Escape"===a.key&&b.closeFrame()})}return _createClass(a,[{key:"attachEventHandler",value:function attachEventHandler(){var a=this,b=$("a.yform-quick-edit");b.off("click"),b.on("click",function(b){b.preventDefault();var c=$(b.currentTarget),d=c.data("id"),e=c.parents("tr"),f=e.find("td").length;return a.showLoading(),a.active===d?(a.closeFrame(),void a.hideLoading()):void(a.active!==d&&(a.closeFrame(),a.active=d,a.frameId="yform-quick-edit-frame-"+(200*Math.random()).toString(36).replace(".",""),a.activeRowSelector="tr.quick-edit-row-"+a.active,a.changeActiveRowClass("active",a.ADD_CLASS),e.after("<tr><td style=\"padding: 0;\" colspan=\""+f+"\"><iframe id=\""+a.frameId+"\" style=\"border: 0; width: 100%; height: 0; display: block\"></iframe></td></tr>"),$("#"+a.frameId).attr("src",c.attr("href")),$(window).scrollTop(e.offset().top),a.setIframe()))})}},{key:"setIframe",value:function setIframe(){this.showLoading(),this.activeFrame=iFrameResize({heightCalculationMethod:"bodyScroll",onMessage:this.receiveMessage.bind(this)},"#"+this.frameId)}},{key:"reload",value:function reload(){this.activeFrame&&$(this.activeFrame[0]).attr("src",function(a,b){return b})}},{key:"resize",value:function resize(){this.activeFrame&&this.activeFrame[0].iFrameResizer.resize()}},{key:"closeFrame",value:function closeFrame(a){var b=this;this.activeFrame&&(this.removeFrame(),this.changeActiveRowClass("active",this.REMOVE_CLASS),this.changeActiveRowClass("error",this.REMOVE_CLASS),a?$.get(window.location.href,function(a){for(var c,d=$(a).find(b.activeRowSelector+" > *"),e=$(b.activeRowSelector+" > *"),f=0;f<d.length;f++){c=void 0;try{if(c=$(e.eq(f).html()),"a"===c.prop("nodeName").toLowerCase())continue}catch(a){}e.eq(f).html(d.eq(f).html())}b.reset()}):this.reset())}},{key:"removeFrame",value:function removeFrame(){if(this.activeFrame){var a=$(this.activeFrame[0]).parents("tr");this.activeFrame[0].iFrameResizer.close(),a.remove()}}},{key:"reset",value:function reset(){this.active=null,this.activeFrame=null,this.activeRowSelector=null}},{key:"addError",value:function addError(){this.changeActiveRowClass("error",this.ADD_CLASS)}},{key:"changeActiveRowClass",value:function changeActiveRowClass(a,b){b===this.ADD_CLASS?$(this.activeRowSelector).addClass(a):b===this.REMOVE_CLASS&&$(this.activeRowSelector).removeClass(a)}},{key:"receiveMessage",value:function receiveMessage(a){switch(a.message){case rex.yform_quick_edit_close:this.closeFrame(!0);break;case rex.yform_quick_edit_reload:this.reload();break;case rex.yform_quick_edit_resize:this.resize();break;case rex.yform_quick_edit_show_loading:this.showLoading();break;case rex.yform_quick_edit_hide_loading:this.hideLoading();break;case rex.yform_quick_edit_error:this.addError();}}},{key:"showLoading",value:function showLoading(){this.$rexAjaxLoader.addClass("rex-visible")}},{key:"hideLoading",value:function hideLoading(){this.$rexAjaxLoader.removeClass("rex-visible")}}]),a}();